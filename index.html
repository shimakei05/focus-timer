<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>集中タイマー</title>
<style>
    body {
        font-family: 'Arial', sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background-color: #f0f0f0;
        color: #333;
        transition: background-color 0.5s ease;
    }
    body.focus-mode-bg {
        background-color: #d4e6f1;
    }
    body.break-mode-bg {
        background-color: #d5f5e3;
    }

    .timer-container {
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 90%;
        max-width: 500px;
    }

    #modeIndicator {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 15px;
        color: #444;
    }

    #timerDisplay {
        font-size: 4rem; /* メインタイマーはHH:MM:SSのまま */
        font-weight: bold;
        margin-bottom: 20px;
        color: #2c3e50;
        background-color: #ecf0f1;
        padding: 15px;
        border-radius: 5px;
    }

    #taskInput {
        width: calc(100% - 22px);
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 1rem;
        min-height: 60px;
        resize: vertical;
    }

    #controlButton, #resetButton {
        font-size: 1.5rem;
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        width: 100%;
        margin-bottom: 10px;
    }
    #controlButton:last-child, #resetButton:last-child {
        margin-bottom: 0;
    }

    #controlButton.focus {
        background-color: #3498db;
        color: white;
    }
    #controlButton.focus:hover {
        background-color: #2980b9;
    }

    #controlButton.break {
        background-color: #2ecc71;
        color: white;
    }
    #controlButton.break:hover {
        background-color: #27ae60;
    }

    #resetButton {
        background-color: #e74c3c;
        color: white;
        margin-top: 20px;
    }
    #resetButton:hover {
        background-color: #c0392b;
    }

    .laps-section {
        margin-top: 20px;
        text-align: left;
        width: 100%;
    }

    .laps-section h3 {
        margin-bottom: 5px;
        color: #7f8c8d;
        border-bottom: 1px solid #bdc3c7;
        padding-bottom: 5px;
    }

    .total-time {
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 1.0rem; /* 少し小さくしてバランス調整 */
    }

    .laps-list {
        list-style-type: none;
        padding: 0;
        max-height: 150px;
        overflow-y: auto;
        background-color: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 3px;
    }

    .laps-list li {
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    .laps-list li:last-child {
        border-bottom: none;
    }
    .lap-duration { /* (HH:MM～HH:MM) のスタイル */
        display: block;
        font-size: 0.8em;
        color: #555;
        margin-left: 25px; /* X回目のインデントに合わせる */
    }
    .lap-task {
        display: block;
        font-size: 0.9em;
        color: #333;
        margin-top: 3px;
        margin-left: 25px; /* X回目のインデントに合わせる */
        white-space: pre-wrap;
        word-break: break-all;
    }

    .columns {
        display: flex;
        justify-content: space-between;
        gap: 20px;
    }
    .column {
        flex: 1;
    }

    @media (max-width: 600px) {
        #modeIndicator {
            font-size: 1.5rem;
        }
        #timerDisplay {
            font-size: 3rem;
        }
        #controlButton, #resetButton {
            font-size: 1.2rem;
        }
        .columns {
            flex-direction: column;
        }
        #taskInput {
            min-height: 40px;
        }
        .total-time {
            font-size: 0.9rem;
        }
    }
</style>
</head>
<body>

<div class="timer-container">
    <div id="modeIndicator">---</div>
    <div id="timerDisplay">00:00:00</div>
    <textarea id="taskInput" placeholder="ここに集中する内容を入力... (任意)"></textarea>
    <button id="controlButton" class="focus">集中スタート！</button>

    <div class="columns">
        <div class="column">
            <div class="laps-section">
                <h3>集中記録</h3>
                <div id="totalFocusTime" class="total-time">トータル集中時間: 00時間00分00秒</div>
                <ul id="focusLapsList" class="laps-list"></ul>
            </div>
        </div>
        <div class="column">
            <div class="laps-section">
                <h3>休憩記録</h3>
                <div id="totalBreakTime" class="total-time">トータル休憩時間: 00時間00分00秒</div>
                <ul id="breakLapsList" class="laps-list"></ul>
            </div>
        </div>
    </div>

    <button id="resetButton">リセット</button>
</div>

<script>
    const bodyElement = document.body;
    const modeIndicator = document.getElementById('modeIndicator');
    const timerDisplay = document.getElementById('timerDisplay');
    const taskInput = document.getElementById('taskInput');
    const controlButton = document.getElementById('controlButton');
    const resetButton = document.getElementById('resetButton');
    const focusLapsList = document.getElementById('focusLapsList');
    const totalFocusTimeDisplay = document.getElementById('totalFocusTime');
    const breakLapsList = document.getElementById('breakLapsList');
    const totalBreakTimeDisplay = document.getElementById('totalBreakTime');

    let timerInterval = null;
    let currentSeconds = 0;
    let currentMode = 'focus';
    let isTimerActive = false;

    let totalFocusSeconds = 0;
    let totalBreakSeconds = 0;
    let focusLapCounter = 0;
    let breakLapCounter = 0;

    let currentSessionStartTime = null;
    let currentTaskDescription = "";

    // formatType: 'timer' (HH:MM:SS), 'japanese' (HH時間MM分SS秒)
    function formatTime(totalSeconds, formatType = 'timer') {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        if (formatType === 'japanese') {
            return String(hours).padStart(2, '0') + '時間' + String(minutes).padStart(2, '0') + '分' + String(seconds).padStart(2, '0') + '秒';
        } else { // default to 'timer'
            return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        }
    }

    function formatHoursMinutes(dateObject) {
        if (!dateObject) return '';
        const hours = String(dateObject.getHours()).padStart(2, '0');
        const minutes = String(dateObject.getMinutes()).padStart(2, '0');
        return hours + ':' + minutes;
    }

    function updateTimerDisplay() {
        timerDisplay.textContent = formatTime(currentSeconds); // メインタイマーはHH:MM:SS形式
    }

    function updateModeIndicatorAndBackground() {
        taskInput.disabled = isTimerActive && currentMode === 'focus';

        if (currentMode === 'focus') {
            if (isTimerActive) {
                modeIndicator.textContent = '集中モード';
            } else {
                modeIndicator.textContent = '集中準備OK';
            }
            bodyElement.classList.add('focus-mode-bg');
            bodyElement.classList.remove('break-mode-bg');
        } else if (currentMode === 'break') {
            modeIndicator.textContent = '休憩モード';
            bodyElement.classList.add('break-mode-bg');
            bodyElement.classList.remove('focus-mode-bg');
        } else {
            modeIndicator.textContent = '---';
            bodyElement.classList.remove('focus-mode-bg', 'break-mode-bg');
        }
    }

    function addLapTime(mode, timeInSeconds, sessionStartTime, sessionEndTime, taskDesc) {
        const lapItem = document.createElement('li');
        let lapNumber;
        const formattedDuration = formatTime(timeInSeconds, 'japanese'); // 日本語形式で時間を取得
        const formattedStartTime = formatHoursMinutes(sessionStartTime);
        const formattedEndTime = formatHoursMinutes(sessionEndTime);
        const timeRange = (formattedStartTime && formattedEndTime) ? '(' + formattedStartTime + '～' + formattedEndTime + ')' : '';
        let taskHtml = '';

        if (mode === 'focus' && taskDesc && typeof taskDesc === 'string' && taskDesc.length > 0) {
            function escapeHtml(unsafeText) {
                var div = document.createElement('div');
                div.textContent = unsafeText;
                return div.innerHTML;
            }
            taskHtml = '<span class="lap-task">内容: ' + escapeHtml(taskDesc) + '</span>';
        }

        if (mode === 'focus') {
            focusLapCounter++;
            lapNumber = focusLapCounter;
            lapItem.innerHTML = focusLapCounter + '回目 ' + formattedDuration + ' <span class="lap-duration">' + timeRange + '</span>' + taskHtml;
            focusLapsList.prepend(lapItem);
        } else { // mode === 'break'
            breakLapCounter++;
            lapNumber = breakLapCounter;
            lapItem.innerHTML = breakLapCounter + '回目 ' + formattedDuration + ' <span class="lap-duration">' + timeRange + '</span>';
            breakLapsList.prepend(lapItem);
        }
    }

    function updateTotalTimeDisplay() {
        totalFocusTimeDisplay.textContent = 'トータル集中時間: ' + formatTime(totalFocusSeconds, 'japanese');
        totalBreakTimeDisplay.textContent = 'トータル休憩時間: ' + formatTime(totalBreakSeconds, 'japanese');
    }

    function startMainTimerInterval() {
        if (timerInterval) clearInterval(timerInterval);
        isTimerActive = true;
        timerInterval = setInterval(function() {
            currentSeconds++;
            updateTimerDisplay();
        }, 1000);
    }

    function stopMainTimerInterval() {
        clearInterval(timerInterval);
        isTimerActive = false;
    }

    function initializeState() {
        stopMainTimerInterval();
        currentSeconds = 0;
        currentMode = 'focus';

        totalFocusSeconds = 0;
        totalBreakSeconds = 0;
        focusLapCounter = 0;
        breakLapCounter = 0;
        currentSessionStartTime = null;
        currentTaskDescription = "";
        taskInput.value = "";

        updateTimerDisplay();
        updateTotalTimeDisplay();
        updateModeIndicatorAndBackground();
        focusLapsList.innerHTML = '';
        breakLapsList.innerHTML = '';

        controlButton.textContent = '集中スタート！';
        controlButton.className = 'focus';
        controlButton.disabled = false;
        taskInput.disabled = false;
    }

    controlButton.addEventListener('click', function() {
        if (currentMode === 'focus') {
            if (!isTimerActive) {
                currentTaskDescription = taskInput.value.trim();
                taskInput.disabled = true;

                controlButton.textContent = '休憩する';
                controlButton.className = 'break';

                currentSeconds = 0;
                currentSessionStartTime = new Date();
                startMainTimerInterval();
            } else {
                stopMainTimerInterval();
                const recordedTime = currentSeconds;
                addLapTime('focus', recordedTime, currentSessionStartTime, new Date(), currentTaskDescription);
                totalFocusSeconds += recordedTime;

                currentMode = 'break';
                controlButton.textContent = '集中スタート！';
                controlButton.className = 'focus';
                taskInput.value = "";
                taskInput.disabled = false;

                currentSeconds = 0;
                currentSessionStartTime = new Date();
                startMainTimerInterval();
            }
        } else { // currentMode === 'break'
            stopMainTimerInterval();
            const recordedTime = currentSeconds;
            addLapTime('break', recordedTime, currentSessionStartTime, new Date());
            totalBreakSeconds += recordedTime;

            currentMode = 'focus';
            currentTaskDescription = taskInput.value.trim();
            taskInput.disabled = true;

            controlButton.textContent = '休憩する';
            controlButton.className = 'break';

            currentSeconds = 0;
            currentSessionStartTime = new Date();
            startMainTimerInterval();
        }
        updateTotalTimeDisplay();
        updateModeIndicatorAndBackground();
    });

    resetButton.addEventListener('click', function() {
        initializeState();
    });

    initializeState();
</script>

</body>
</html>
