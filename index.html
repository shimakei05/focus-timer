<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>集中タイマー</title>
<style>
    body {
        font-family: 'Arial', sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
        padding-bottom: 20px;
        min-height: 100vh;
        margin: 0;
        background-color: #f0f0f0;
        color: #333;
        transition: background-color 0.5s ease;
    }
    body.focus-mode-bg {
        background-color: #d4e6f1;
    }
    body.break-mode-bg {
        background-color: #d5f5e3;
    }

    .timer-container {
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 90%;
        max-width: 500px;
        margin-bottom: 30px;
    }

    #modeIndicator {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 15px;
        color: #444;
    }

    #timerDisplay {
        font-size: 4rem;
        font-weight: bold;
        margin-bottom: 20px;
        color: #2c3e50;
        background-color: #ecf0f1;
        padding: 15px;
        border-radius: 5px;
    }

    #taskInput {
        width: calc(100% - 22px);
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 1rem;
        min-height: 60px;
        resize: vertical;
    }

    #controlButton, #resetButton {
        font-size: 1.5rem;
        padding: 12px 25px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        width: 100%;
        margin-bottom: 10px;
    }
    #controlButton:last-child, #resetButton:last-child {
        margin-bottom: 0;
    }

    #controlButton.focus {
        background-color: #3498db;
        color: white;
    }
    #controlButton.focus:hover {
        background-color: #2980b9;
    }

    #controlButton.break {
        background-color: #2ecc71;
        color: white;
    }
    #controlButton.break:hover {
        background-color: #27ae60;
    }

    #resetButton {
        background-color: #e74c3c;
        color: white;
        margin-top: 20px;
    }
    #resetButton:hover {
        background-color: #c0392b;
    }

    .laps-section {
        margin-top: 20px;
        text-align: left;
        width: 100%;
    }

    .laps-section h3 {
        margin-bottom: 5px;
        color: #7f8c8d;
        border-bottom: 1px solid #bdc3c7;
        padding-bottom: 5px;
    }

    .total-time {
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 1.0rem;
    }

    .laps-list {
        list-style-type: none;
        padding: 0;
        max-height: 150px;
        overflow-y: auto;
        background-color: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 3px;
    }

    .laps-list li {
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    .laps-list li:last-child {
        border-bottom: none;
    }
    .lap-duration {
        display: block;
        font-size: 0.8em;
        color: #555;
        margin-left: 25px;
    }
    .lap-task {
        display: block;
        font-size: 0.9em;
        color: #333;
        margin-top: 3px;
        margin-left: 25px;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .columns {
        display: flex;
        justify-content: space-between;
        gap: 20px;
    }
    .column {
        flex: 1;
    }

    .usage-guide {
        width: 90%;
        max-width: 500px;
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #ddd;
        text-align: left;
        font-size: 0.9rem;
        line-height: 1.6;
        color: #555;
    }
    .usage-guide h4 {
        margin-top: 0;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 10px;
    }
    .usage-guide ul {
        padding-left: 20px;
        margin-top: 0;
    }
    .usage-guide li {
        margin-bottom: 8px;
    }

    @media (max-width: 600px) {
        body {
            padding-top: 10px;
            padding-bottom: 10px;
        }
        .timer-container {
            margin-bottom: 20px;
            padding: 20px;
        }
        #modeIndicator {
            font-size: 1.5rem;
        }
        #timerDisplay {
            font-size: 3rem;
        }
        #controlButton, #resetButton {
            font-size: 1.2rem;
        }
        .columns {
            flex-direction: column;
        }
        #taskInput {
            min-height: 40px;
        }
        .total-time {
            font-size: 0.9rem;
        }
        .usage-guide {
            font-size: 0.85rem;
            padding: 15px;
        }
        .usage-guide ul {
            padding-left: 15px;
        }
    }
</style>
</head>
<body>

<div class="timer-container">
    <div id="modeIndicator">---</div>
    <div id="timerDisplay">00:00:00</div>
    <textarea id="taskInput" placeholder="ここに集中する内容を入力... (任意)"></textarea>
    <button id="controlButton" class="focus">集中スタート！</button>

    <div class="columns">
        <div class="column">
            <div class="laps-section">
                <h3>集中記録</h3>
                <div id="totalFocusTime" class="total-time">トータル集中時間: 00時間00分00秒</div>
                <ul id="focusLapsList" class="laps-list"></ul>
            </div>
        </div>
        <div class="column">
            <div class="laps-section">
                <h3>休憩記録</h3>
                <div id="totalBreakTime" class="total-time">トータル休憩時間: 00時間00分00秒</div>
                <ul id="breakLapsList" class="laps-list"></ul>
            </div>
        </div>
    </div>

    <button id="resetButton">リセット</button>
</div>

<div class="usage-guide">
    <h4>タイマーの使い方</h4>
    <ul>
        <li><strong>集中開始:</strong> 上のテキストエリアに集中する内容（例: 「ブログを書く」「資料作成」など、任意）を入力し、「集中スタート！」ボタンを押すと、集中時間の計測が始まります。入力した内容は、後で集中記録に表示されます。</li>
        <li><strong>休憩開始:</strong> 集中作業が終わった時や、一旦休憩する時は「休憩する」ボタンを押します。その時点までの集中時間が記録され、休憩時間の計測が自動的に始まります。</li>
        <li><strong>集中再開:</strong> 休憩を終えるときは「集中スタート！」ボタンを押します。上のテキストエリアに集中する内容を入力してから「集中スタート！」ボタンを押しましょう。休憩時間が記録され、再度集中時間の計測が始まります。</li>
        <li><strong>記録の確認:</strong> 「集中記録」「休憩記録」に各セッションの時間と、集中時には入力した内容、それぞれの開始・終了時刻が表示されます。</li>
        <li><strong>トータル時間:</strong> 各記録の上には、集中時間と休憩時間それぞれのトータル時間が表示されます。</li>
        <li><strong>リセット:</strong> 「リセット」ボタンを押すと、全てのタイマー、記録、入力内容が初期状態に戻ります。</li>
        <li><strong>注意点:</strong> このタイマーの記録は、お使いのブラウザ上に一時的に保存されるものです。ブラウザを閉じたり、ページを更新したりすると記録は消えてしまいますのでご注意ください。</li>
    </ul>
</div>

<script>
    const bodyElement = document.body;
    const modeIndicator = document.getElementById('modeIndicator');
    const timerDisplay = document.getElementById('timerDisplay');
    const taskInput = document.getElementById('taskInput');
    const controlButton = document.getElementById('controlButton');
    const resetButton = document.getElementById('resetButton');
    const focusLapsList = document.getElementById('focusLapsList');
    const totalFocusTimeDisplay = document.getElementById('totalFocusTime');
    const breakLapsList = document.getElementById('breakLapsList');
    const totalBreakTimeDisplay = document.getElementById('totalBreakTime');

    let timerInterval = null;
    let currentSeconds = 0; // 表示用の現在の秒数
    let currentMode = 'focus';
    let isTimerActive = false;

    let totalFocusSeconds = 0;
    let totalBreakSeconds = 0;
    let focusLapCounter = 0;
    let breakLapCounter = 0;

    let currentSessionStartTime = null; // Dateオブジェクトを保持
    let currentTaskDescription = "";

    function formatTime(totalSeconds, formatType = 'timer') {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        if (formatType === 'japanese') {
            return String(hours).padStart(2, '0') + '時間' + String(minutes).padStart(2, '0') + '分' + String(seconds).padStart(2, '0') + '秒';
        } else {
            return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
        }
    }

    function formatHoursMinutes(dateObject) {
        if (!dateObject) return '';
        const hours = String(dateObject.getHours()).padStart(2, '0');
        const minutes = String(dateObject.getMinutes()).padStart(2, '0');
        return hours + ':' + minutes;
    }

    function updateTimerDisplay() {
        // isTimerActive の場合のみ、現在の時間と開始時間の差から currentSeconds を更新
        if (isTimerActive && currentSessionStartTime) {
            const now = new Date();
            currentSeconds = Math.round((now - currentSessionStartTime) / 1000);
        }
        timerDisplay.textContent = formatTime(currentSeconds);
    }

    function updateModeIndicatorAndBackground() {
        taskInput.disabled = isTimerActive && currentMode === 'focus';

        if (currentMode === 'focus') {
            if (isTimerActive) {
                modeIndicator.textContent = '集中モード';
            } else {
                modeIndicator.textContent = '集中準備OK';
            }
            bodyElement.classList.add('focus-mode-bg');
            bodyElement.classList.remove('break-mode-bg');
        } else if (currentMode === 'break') {
            modeIndicator.textContent = '休憩モード';
            bodyElement.classList.add('break-mode-bg');
            bodyElement.classList.remove('focus-mode-bg');
        } else {
            modeIndicator.textContent = '---';
            bodyElement.classList.remove('focus-mode-bg', 'break-mode-bg');
        }
    }

    function addLapTime(mode, timeInSeconds, sessionStartTime, sessionEndTime, taskDesc) {
        const lapItem = document.createElement('li');
        let lapNumber;
        const formattedDuration = formatTime(timeInSeconds, 'japanese');
        const formattedStartTime = formatHoursMinutes(sessionStartTime);
        const formattedEndTime = formatHoursMinutes(sessionEndTime);
        const timeRange = (formattedStartTime && formattedEndTime) ? '(' + formattedStartTime + '～' + formattedEndTime + ')' : '';
        let taskHtml = '';

        if (mode === 'focus' && taskDesc && typeof taskDesc === 'string' && taskDesc.length > 0) {
            function escapeHtml(unsafeText) {
                var div = document.createElement('div');
                div.textContent = unsafeText;
                return div.innerHTML;
            }
            taskHtml = '<span class="lap-task">内容: ' + escapeHtml(taskDesc) + '</span>';
        }

        if (mode === 'focus') {
            focusLapCounter++;
            lapNumber = focusLapCounter;
            lapItem.innerHTML = focusLapCounter + '回目 ' + formattedDuration + ' <span class="lap-duration">' + timeRange + '</span>' + taskHtml;
            focusLapsList.prepend(lapItem);
        } else {
            breakLapCounter++;
            lapNumber = breakLapCounter;
            lapItem.innerHTML = breakLapCounter + '回目 ' + formattedDuration + ' <span class="lap-duration">' + timeRange + '</span>';
            breakLapsList.prepend(lapItem);
        }
    }

    function updateTotalTimeDisplay() {
        totalFocusTimeDisplay.textContent = 'トータル集中時間: ' + formatTime(totalFocusSeconds, 'japanese');
        totalBreakTimeDisplay.textContent = 'トータル休憩時間: ' + formatTime(totalBreakSeconds, 'japanese');
    }

    function startMainTimerInterval() {
        console.log("startMainTimerInterval called. currentMode:", currentMode);
        if (timerInterval) clearInterval(timerInterval);
        isTimerActive = true;
        // currentSessionStartTime はこの関数の呼び出し元で設定済みのはず
        // currentSeconds は updateTimerDisplay で計算するので、ここでは0にしない

        timerInterval = setInterval(function() {
            // 毎秒 updateTimerDisplay を呼び出して表示を更新する
            updateTimerDisplay();
        }, 1000); // 1秒ごとに表示を更新
        console.log("Timer started. Interval ID:", timerInterval);
    }

    function stopMainTimerInterval() {
        console.log("stopMainTimerInterval called. Interval ID to clear:", timerInterval);
        clearInterval(timerInterval);
        isTimerActive = false;
        // 停止時に正確な経過時間を計算して currentSeconds に設定
        if (currentSessionStartTime) {
            const now = new Date();
            currentSeconds = Math.round((now - currentSessionStartTime) / 1000);
            updateTimerDisplay(); // 最後の表示を更新
        }
        console.log("Timer stopped. isTimerActive:", isTimerActive, "Final currentSeconds:", currentSeconds);
    }

    function initializeState() {
        console.log("initializeState called");
        if (timerInterval) clearInterval(timerInterval); // isTimerActiveをfalseにする前にクリア
        isTimerActive = false; // stopMainTimerInterval を呼ばないのでここで設定
        timerInterval = null;

        currentSeconds = 0;
        currentMode = 'focus';

        totalFocusSeconds = 0;
        totalBreakSeconds = 0;
        focusLapCounter = 0;
        breakLapCounter = 0;
        currentSessionStartTime = null;
        currentTaskDescription = "";
        taskInput.value = "";

        updateTimerDisplay(); // currentSeconds が 0 になっているので表示も0になる
        updateTotalTimeDisplay();
        updateModeIndicatorAndBackground();
        focusLapsList.innerHTML = '';
        breakLapsList.innerHTML = '';

        controlButton.textContent = '集中スタート！';
        controlButton.className = 'focus';
        controlButton.disabled = false;
        taskInput.disabled = false;
        console.log("State initialized");
    }

    controlButton.addEventListener('click', function() {
        console.log("--- Button clicked ---");
        console.log("Before action - Mode:", currentMode, "Active:", isTimerActive, "Seconds:", currentSeconds, "StartTime:", currentSessionStartTime);

        if (currentMode === 'focus') {
            if (!isTimerActive) { // 「集中スタート！」ボタン (集中開始)
                console.log("Action: Start Focus");
                currentTaskDescription = taskInput.value.trim();
                taskInput.disabled = true;

                controlButton.textContent = '休憩する';
                controlButton.className = 'break';

                currentSeconds = 0; // 新しいセッションなので0から
                currentSessionStartTime = new Date(); // 開始時刻を記録
                updateTimerDisplay(); // 0秒表示
                startMainTimerInterval();
                console.log("Focus started. Task:", currentTaskDescription, "Start time:", currentSessionStartTime);
            } else { // 「休憩する」ボタン (集中終了 -> 休憩開始)
                console.log("Action: End Focus, Start Break");
                stopMainTimerInterval(); // タイマーを止め、正確なcurrentSecondsを計算
                const recordedTime = currentSeconds; // stopMainTimerIntervalで計算された正確な値
                console.log("Focus ended. Recorded time (sec):", recordedTime, "Session start:", currentSessionStartTime, "End time:", new Date());
                addLapTime('focus', recordedTime, currentSessionStartTime, new Date(), currentTaskDescription);
                totalFocusSeconds += recordedTime;
                console.log("Total focus time (sec):", totalFocusSeconds);

                currentMode = 'break';
                controlButton.textContent = '集中スタート！';
                controlButton.className = 'focus';
                taskInput.value = "";
                taskInput.disabled = false;

                currentSeconds = 0; // 休憩タイマーリセット
                currentSessionStartTime = new Date(); // 休憩開始時刻
                updateTimerDisplay(); // 0秒表示
                startMainTimerInterval(); // 休憩タイマー開始
                console.log("Break started. Session start time:", currentSessionStartTime);
            }
        } else { // currentMode === 'break' (「集中スタート！」ボタンが押されたので休憩終了 -> 集中再開)
            console.log("Action: End Break, Start Focus");
            stopMainTimerInterval(); // タイマーを止め、正確なcurrentSecondsを計算
            const recordedTime = currentSeconds; // stopMainTimerIntervalで計算された正確な値
            console.log("Break ended. Recorded time (sec):", recordedTime, "Session start:", currentSessionStartTime, "End time:", new Date());
            addLapTime('break', recordedTime, currentSessionStartTime, new Date());
            totalBreakSeconds += recordedTime;
            console.log("Total break time (sec):", totalBreakSeconds);

            currentMode = 'focus';
            taskInput.disabled = false; // 次の集中内容を入力可能に

            controlButton.textContent = '集中スタート！'; // ユーザーが再度押すのを待つ
            // isTimerActive は stopMainTimerInterval で false になっている
            currentSeconds = 0;    // 表示タイマーリセット
            updateTimerDisplay(); // 0秒表示
            currentSessionStartTime = null; // 次の開始時刻はまだ
            console.log("Ready for next focus session. Enter task and press '集中スタート！'");
        }
        updateTotalTimeDisplay();
        updateModeIndicatorAndBackground();
        console.log("After action - Mode:", currentMode, "Active:", isTimerActive, "Seconds:", currentSeconds, "StartTime:", currentSessionStartTime);
        console.log("--- Click event finished ---");
    });

    resetButton.addEventListener('click', function() {
        console.log("Reset button clicked. Initializing state.");
        initializeState();
    });

    console.log("Initializing timer state on page load.");
    initializeState();
</script>

</body>
</html>
